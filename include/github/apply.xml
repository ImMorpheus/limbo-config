<?xml version="1.0" encoding="utf-8"?>
<limbo>
  <github>
    <apply>
      <apply>
        <filter>
          <any>
            <ref id="spongeapi"/>
            <ref id="spongecommon"/>
            <ref id="spongeforge"/>
            <ref id="spongevanilla"/>
          </any>
        </filter>

        <actions>
          <!-- all new issues require triage -->
          <normal>
            <filter id="is-o-ns"/>

            <action>
              <label>
                <add>status: needs triage</add>
              </label>
            </action>
          </normal>

          <!-- assume that the person who has added labels has triaged -->
          <normal>
            <filter>
              <all>
                <filter id="not-self"/>
                <any>
                  <event>issue label</event>
                  <event>pull request label</event>
                </any>
              </all>
            </filter>

            <action>
              <label>
                <remove>status: needs triage</remove>
              </label>
            </action>
          </normal>

          <!-- search for a version -->
          <pattern type="where" pattern="(?:(\d+\.\d+(?:\.\d+))-)(\d+)?-?(\d+\.\d+(?:\.\d+)?(?:-[A-Z]*))-?(\d+)">
            <filter id="is-o-ns"/>

            <where group="1">
              <match>
                <value>1.10</value>
                <value>1.10.2</value>

                <apply close="true">
                  <comment src="auto_close_unsupported_version.md">
                    <tokens>
                      <token name="version" value="1.10"/>
                      <token name="version_ended" value="in January 2018"/>
                    </tokens>
                  </comment>
                  <label>
                    <add>resolution: unsupported</add>
                    <remove>status: needs triage</remove>
                    <add>version: 1.10 (u)</add>
                  </label>
                </apply>
              </match>

              <match>
                <value>1.11</value>
                <value>1.11.2</value>

                <apply close="true">
                  <comment src="auto_close_unsupported_version.md">
                    <tokens>
                      <token name="version" value="1.11"/>
                      <token name="version_ended" value="in January 2018"/>
                    </tokens>
                  </comment>
                  <label>
                    <add>resolution: unsupported</add>
                    <remove>status: needs triage</remove>
                    <add>version: 1.11 (u)</add>
                  </label>
                </apply>
              </match>

              <match>
                <value>1.12</value>
                <value>1.12.2</value>

                <apply>
                  <label>
                    <add>version: 1.12</add>
                  </label>
                </apply>
              </match>
            </where>
          </pattern>

          <pattern type="find" pattern="~wip">
            <filter id="pr-co-ac"/>

            <action>
              <label>
                <add>status: wip</add>
                <remove>status: needs review</remove>
                <remove>status: needs testing</remove>
                <remove>status: ready to merge</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~qa">
            <filter id="pr-co-ac"/>

            <action>
              <label>
                <add>status: needs review</add>
                <add>status: needs testing</add>
                <remove>status: ready to merge</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~tested">
            <filter id="pr-c-c"/>

            <action>
              <label>
                <remove>status: needs testing</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~reviewed">
            <filter id="pr-c-c"/>

            <action>
              <label>
                <remove>status: needs review</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~ready">
            <filter id="pr-c-c"/>

            <action>
              <label>
                <add>status: ready to merge</add>
                <remove>status: needs testing</remove>
                <remove>status: needs review</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>
        </actions>
      </apply>
    </apply>
  </github>
</limbo>