<?xml version="1.0" encoding="utf-8"?>
<limbo>
  <repositories>
    <repositories user="SpongePowered">
      <repository id="sponge-api" repo="SpongeAPI">
        <tag>api</tag>
        <tag>sa</tag>
      </repository>
      <repository id="sponge-common" repo="SpongeCommon">
        <tag>common</tag>
        <tag>sc</tag>
      </repository>
      <repository id="sponge-forge" repo="SpongeForge">
        <tag>forge</tag>
        <tag>sf</tag>
      </repository>
      <repository id="sponge-vanilla" repo="SpongeVanilla">
        <tag>vanilla</tag>
        <tag>sv</tag>
      </repository>
    </repositories>
  </repositories>

  <filters>
    <!-- create filters for repositories -->
    <repository id="sponge-api" ref="sponge-api"/>
    <repository id="sponge-common" ref="sponge-common"/>
    <repository id="sponge-forge" ref="sponge-forge"/>
    <repository id="sponge-vanilla" ref="sponge-vanilla"/>

    <!-- pull request comment/open by author/collaborator-->
    <all id="pr-co-ac">
      <any>
        <actor>author</actor>
        <actor>collaborator</actor>
      </any>
      <any>
        <event>pull request comment</event>
        <event>pull request open</event>
      </any>
    </all>

    <!-- pull request comment by collaborator-->
    <all id="pr-c-c">
      <actor>collaborator</actor>
      <event>pull request comment</event>
    </all>
  </filters>

  <discord>
    <github-issue-ref>
      <search pattern="~([a-zA-Z0-9]{1,})-([0-9]{1,})">
        <repositories>
          <repository ref="sponge-api"/>
          <repository ref="sponge-common"/>
          <repository ref="sponge-forge"/>
          <repository ref="sponge-vanilla"/>
        </repositories>
      </search>
      <state>
        <open>
          <message>
            <embed color="#58c858">
              <title>${tag}-${number}: ${title}</title>
              <url>${url}</url>
              <description>**State**: open</description>
            </embed>
          </message>
        </open>
        <closed>
          <message>
            <embed color="#c85858">
              <title>${tag}-${number}: ${title}</title>
              <url>${url}</url>
              <description>**State**: closed</description>
            </embed>
          </message>
        </closed>
        <merged>
          <message>
            <embed color="#9058c8">
              <title>${tag}-${number}: ${title}</title>
              <url>${url}</url>
              <description>**State**: merged</description>
            </embed>
          </message>
        </merged>
      </state>
    </github-issue-ref>
  </discord>

  <github>
    <actions>
      <!-- issue move source -->
      <action id="is-move-source" close="true">
        <comment src="issue_move_source.md"/>
        <label>
          <add>resolution: moved</add>
        </label>
      </action>

      <!-- issue move target -->
      <action id="is-move-target">
        <comment src="issue_move_target.md"/>
      </action>
    </actions>

    <apply>
      <apply>
        <filter>
          <any>
            <filter id="sponge-api"/>
            <filter id="sponge-common"/>
            <filter id="sponge-forge"/>
            <filter id="sponge-vanilla"/>
          </any>
        </filter>

        <actions>
          <pattern type="find" pattern="~wip">
            <filter id="pr-co-ac"/>

            <action>
              <label>
                <add>status: wip</add>
                <remove>status: needs review</remove>
                <remove>status: needs testing</remove>
                <remove>status: ready to merge</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~qa">
            <filter id="pr-co-ac"/>

            <action>
              <label>
                <add>status: needs review</add>
                <add>status: needs testing</add>
                <remove>status: ready to merge</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~tested">
            <filter id="pr-c-c"/>

            <action>
              <label>
                <remove>status: needs testing</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~reviewed">
            <filter id="pr-c-c"/>

            <action>
              <label>
                <remove>status: needs review</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>

          <pattern type="find" pattern="~ready">
            <filter id="pr-c-c"/>

            <action>
              <label>
                <add>status: ready to merge</add>
                <remove>status: needs testing</remove>
                <remove>status: needs review</remove>
                <remove>status: wip</remove>
              </label>
            </action>
          </pattern>
        </actions>
      </apply>
    </apply>

    <move pattern="~move to ([a-z0-9-_]*)">
      <move>
        <source repository="sponge-api" action="is-move-source"/>

        <targets action="is-move-target">
          <target repository="sponge-common"/>
          <target repository="sponge-forge"/>
          <target repository="sponge-vanilla"/>
        </targets>
      </move>

      <move>
        <source repository="sponge-common" action="is-move-source"/>

        <targets action="is-move-target">
          <target repository="sponge-api"/>
          <target repository="sponge-forge"/>
          <target repository="sponge-vanilla"/>
        </targets>
      </move>

      <move>
        <source repository="sponge-forge" action="is-move-source"/>

        <targets action="is-move-target">
          <target repository="sponge-api"/>
          <target repository="sponge-common"/>
          <target repository="sponge-vanilla"/>
        </targets>
      </move>

      <move>
        <source repository="sponge-vanilla" action="is-move-source"/>

        <targets action="is-move-target">
          <target repository="sponge-api"/>
          <target repository="sponge-common"/>
          <target repository="sponge-forge"/>
        </targets>
      </move>
    </move>
  </github>
</limbo>